version: 2.1
orbs:
  ruby: circleci/ruby@1.1.2

executors:
  ruby_2_7:
    docker:
    - image: circleci/ruby:2.7-browsers-legacy
  node:
    docker:
      - image: circleci/node:14

jobs:
  test_browsers:
    executor: node
    environment:
      USE_SAUCE: "true"
    steps:
    - checkout
    - run:
        name: Report versions
        command: "echo 'Node version:' && node -v && echo 'NPM version:' && npm -v"
    - run:
        name: Install NPM packages
        command: "npm install"
    - run:
        name: Install Sauce Connect
        command: |
          cd /tmp
          curl https://saucelabs.com/downloads/sc-4.6.4-linux.tar.gz | tar zxf -
          chmod +x sc-4.6.4-linux/bin/sc
          mkdir ~/bin
          cp sc-4.6.4-linux/bin/sc ~/bin
          ~/bin/sc --version
    - run:
        name: Run tests
        command: scripts/ci.sh

workflows:
  version: 2
  push: &push_workflow
    jobs:
    - test_browsers
  cron:
    <<: *push_workflow
    triggers:
    - schedule:
        # Times are UTC.
        cron: "0 10 * * *"
        filters:
          branches:
            only:
            - main
