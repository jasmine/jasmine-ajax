version: 2.1
orbs:
  ruby: circleci/ruby@1.1.2

executors:
  ruby_2_7:
    docker:
    - image: circleci/ruby:2.7-browsers-legacy

jobs:
  test:
    executor: ruby_2_7
    environment:
      USE_SAUCE: "true"
    steps:
    - checkout
    - run:
        name: Install Node
        command: sudo apt-get install nodejs npm
    - run:
        name: Install bundler
        command: gem install bundler
    - run:
        name: Report versions
        command: "echo 'Ruby version:' && ruby -v && echo 'Bundler version:' && bundle -v && echo 'Node version:' && node -v"
    - run:
        name: Install gems
        command: "bundle install"
    - run:
        name: Install NPM packages
        command: "npm install"
    - run:
        name: Install Sauce Connect
        command: |
          cd /tmp
          curl https://saucelabs.com/downloads/sc-4.6.4-linux.tar.gz | tar zxf -
          chmod +x sc-4.6.4-linux/bin/sc
          mkdir ~/bin
          cp sc-4.6.4-linux/bin/sc ~/bin
          ~/bin/sc --version
    - run:
        name: Run tests
        command: scripts/ci.sh

workflows:
  version: 2
  push: &push_workflow
    jobs:
    - test
  cron:
    <<: *push_workflow
    triggers:
    - schedule:
        # Times are UTC.
        cron: "0 10 * * *"
        filters:
          branches:
            only:
            - main
